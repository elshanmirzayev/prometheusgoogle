name: Deploy Prometheus

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        version: 'latest'

    - name: Install gke-gcloud-auth-plugin
      run: |
        gcloud components install gke-gcloud-auth-plugin

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} --zone ${{ secrets.GKE_CLUSTER_ZONE }} --project ${{ secrets.GCP_PROJECT_ID }}

    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    
    # - name: Add Prometheus Helm repository
    #   run: |
    #     helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    #     helm repo update

    # - name: Deploy Prometheus
    #   run: |
    #     helm upgrade --install prometheus prometheus-community/prometheus \
    #       --set server.service.type=LoadBalancer \
    #       --namespace monitoring --create-namespace

    # - name: Get Prometheus External IP
    #   run: |
    #     kubectl get svc prometheus-server -n monitoring

    - name: Deploy Prometheus
      run: |
        helm upgrade --install prometheus stable/prometheus -f path/to/prometheus/values.yaml

    - name: Deploy Grafana
      run: |
        helm upgrade --install grafana stable/grafana -f path/to/grafana/values.yaml

    - name: Expose Grafana
      run: |
        kubectl patch svc grafana --type='json' -p '[{"op":"replace","path":"/spec/type","value":"LoadBalancer"}]'

    - name: Get Grafana External IP
      id: grafana-ip
      run: |
        echo "::set-output name=ip::$(kubectl get svc grafana -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"

    - name: Print Grafana IP
      run: |
        echo "Grafana can be accessed at http://${{ steps.grafana-ip.outputs.ip }}/"